{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["/**\r\n * \u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u526F\u4F5C\u7528\u51FD\u6570\r\n */\r\nexport let activeSub: Function | undefined;\r\n\r\n/**\r\n * effect \u54CD\u5E94\u5F0F\u53D8\u91CF\u66F4\u65B0\u540E\u4F1A\u91CD\u65B0\u6267\u884C\u4F20\u5165\u7684\u51FD\u6570\r\n * @param fn \u9700\u8981\u6267\u884C\u7684\u51FD\u6570\r\n */\r\nexport function effect(fn: Function) {\r\n  activeSub = fn;\r\n  activeSub();\r\n\r\n  activeSub = undefined;\r\n}\r\n", "import { RefImpl } from \"./ref\";\r\n\r\nexport interface Link {\r\n  /**\r\n   * \u4FDD\u5B58effect\r\n   */\r\n  sub: Function;\r\n  /**\r\n   * \u4E0B\u4E00\u4E2A\u8282\u70B9\r\n   */\r\n  nextSub: Link | undefined;\r\n  /**\r\n   * \u4E0A\u4E00\u4E2A\u8282\u70B9\r\n   */\r\n  prevSub: Link | undefined;\r\n}\r\n\r\n/**\r\n * \u8FDE\u63A5\u94FE\u8868\u5173\u7CFB\r\n * @param dep \u4F9D\u8D56\u5BF9\u8C61\uFF0C\u5305\u542B\u8BA2\u9605\u8005\u94FE\u8868\r\n * @param sub \u8BA2\u9605\u8005\u51FD\u6570(\u5C31\u662Feffect\u4E2D\u7684activeSub)\r\n */\r\nexport function link<T>(dep: RefImpl<T>, sub: Function) {\r\n  // \u5982\u679C activeSub \u6709\u503C\uFF0C\u90A3\u5C31\u4FDD\u5B58\u8D77\u6765\uFF0C\u7B49\u6211\u66F4\u65B0\u7684\u65F6\u5019\uFF0C\u89E6\u53D1\r\n  const newLink = {\r\n    sub: sub,\r\n    nextSub: undefined,\r\n    prevSub: undefined,\r\n  };\r\n\r\n  /**\r\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB\uFF0C\u5206\u4E24\u79CD\u60C5\u51B5\r\n   * 1. \u5C3E\u7ED3\u70B9\u6709\uFF0C\u90A3\u5C31\u5F80\u5C3E\u7ED3\u70B9\u6DFB\u52A0\r\n   * 2. \u5982\u679C\u5C3E\u7ED3\u70B9\u6CA1\u6709\uFF0C\u5219\u8868\u793A\u7B2C\u4E00\u6B21\u5173\u8054\uFF0C\u90A3\u5C31\u5F80\u5934\u7ED3\u70B9\u6DFB\u52A0\uFF0C\u5934\u5C3E\u76F8\u540C\r\n   */\r\n  if (dep.subsTail) {\r\n    // \u5982\u679C\u6709\u5C3E\u8282\u70B9\uFF0C\u8BF4\u660E\u94FE\u8868\u4E0D\u4E3A\u7A7A\r\n    dep.subsTail.nextSub = newLink; // \u5C06\u65B0\u8282\u70B9\u6DFB\u52A0\u5230\u5C3E\u90E8\r\n    newLink.prevSub = dep.subsTail; // \u65B0\u8282\u70B9\u7684 prevSub \u6307\u5411\u5F53\u524D\u5C3E\u8282\u70B9\r\n    dep.subsTail = newLink; // \u66F4\u65B0\u5C3E\u8282\u70B9\u4E3A\u65B0\u8282\u70B9\r\n  } else {\r\n    // \u5982\u679C\u6CA1\u6709\u5C3E\u8282\u70B9\uFF0C\u8BF4\u660E\u94FE\u8868\u4E3A\u7A7A \u5934\u8282\u70B9\u4E5F\u6CA1\u6709\r\n    dep.subs = newLink; // \u5C06\u65B0\u8282\u70B9\u4F5C\u4E3A\u5934\u8282\u70B9\r\n    dep.subsTail = newLink; // \u5934\u8282\u70B9\u4E5F\u662F\u5C3E\u8282\u70B9\r\n  }\r\n}\r\n\r\n/**\r\n * \u4F20\u64AD\u66F4\u65B0\u7684\u51FD\u6570\r\n * @param subs \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n */\r\nexport function propagate(subs: Link | undefined) {\r\n  // \u901A\u77E5 effect \u91CD\u65B0\u6267\u884C\uFF0C\u83B7\u53D6\u5230\u6700\u65B0\u7684\u503C\r\n  let link = subs;\r\n  let queuedEffect: Function[] = [];\r\n\r\n  while (link) {\r\n    queuedEffect.push(link.sub);\r\n    link = link.nextSub;\r\n  }\r\n\r\n  // \u6267\u884C\u6BCF\u4E2A effect \u51FD\u6570\r\n  queuedEffect.forEach((effect) => effect());\r\n}\r\n", "import { activeSub } from \"./effect\";\r\nimport { Link, link, propagate } from \"./system\";\r\n\r\nenum ReactiveFlags {\r\n  /**\r\n   * \u6807\u8BC6\u4E00\u4E2A\u5BF9\u8C61\u662F\u54CD\u5E94\u5F0F\u7684\u5F15\u7528\u7C7B\u578B\r\n   */\r\n  IS_REF = \"__v_isRef\",\r\n}\r\n\r\nexport class RefImpl<T> {\r\n  /**\r\n   * \u5B58\u50A8\u5B9E\u9645\u7684\u503C\r\n   */\r\n  private _value: T;\r\n\r\n  /**\r\n   * \u6807\u8BC6\u8BE5\u5BF9\u8C61\u662F\u54CD\u5E94\u5F0F\u5F15\u7528\u7C7B\u578B ref\u6807\u8BB0\uFF0C\u8BC1\u660E\u662F\u4E00\u4E2A ref\r\n   */\r\n  protected [ReactiveFlags.IS_REF]: boolean = true;\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9,\u7406\u89E3\u4E3Ahead\r\n   */\r\n  subs: Link;\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\uFF0C\u7406\u89E3\u4E3Atail\r\n   */\r\n  subsTail: Link;\r\n\r\n  constructor(value: T) {\r\n    this._value = value;\r\n  }\r\n\r\n  get value(): T {\r\n    // \u6536\u96C6\u4F9D\u8D56 \u6765\u81EA\u4E8E effect.ts \u4E2D\u7684 activeSub(\u662F\u4E00\u4E2A\u51FD\u6570)\r\n    if (activeSub) {\r\n      trackRef(this);\r\n    }\r\n\r\n    return this._value;\r\n  }\r\n\r\n  set value(newValue: T) {\r\n    // \u89E6\u53D1\u4F9D\u8D56\u66F4\u65B0\r\n\r\n    this._value = newValue;\r\n    triggerRef(this);\r\n  }\r\n}\r\n\r\n/**\r\n * \u521B\u5EFA\u4E00\u4E2A\u54CD\u5E94\u5F0F\u5F15\u7528\u5BF9\u8C61\r\n * @param value \u5C06\u8981\u5305\u88C5\u6210\u54CD\u5E94\u5F0F\u7684\u503C\r\n * @returns\r\n */\r\nexport function ref<T>(value: T) {\r\n  return new RefImpl<T>(value);\r\n}\r\n\r\n/**\r\n * \u5224\u65AD\u4E00\u4E2A\u503C\u662F\u5426\u662F\u54CD\u5E94\u5F0F\u5F15\u7528\u7C7B\u578B(ref)\r\n * @param value \u5C06\u8981\u5224\u65AD\u7684\u503C\r\n * @returns\r\n */\r\nexport function isRef(value) {\r\n  return !!(value && value[ReactiveFlags.IS_REF]);\r\n}\r\n\r\n/**\r\n * \u6536\u96C6\u4F9D\u8D56\uFF0C\u5EFA\u7ACB ref\u4E0Eeffect\u7684\u94FE\u8868\u5173\u7CFB\r\n * @param dep ref \u5BF9\u8C61\r\n */\r\nexport function trackRef<T>(dep: RefImpl<T>) {\r\n  if (activeSub) {\r\n    link(dep, activeSub);\r\n  }\r\n}\r\n\r\n/**\r\n * \u89E6\u53D1 ref \u5173\u8054\u7684 effect \u91CD\u65B0\u6267\u884C\r\n * @param dep ref \u5BF9\u8C61\r\n */\r\nexport function triggerRef<T>(dep: RefImpl<T>) {\r\n  if (dep.subs) {\r\n    // \u89E6\u53D1\u4F9D\u8D56\u66F4\u65B0\r\n    propagate(dep.subs);\r\n  }\r\n}\r\n"],
  "mappings": ";AAGO,IAAI;AAMJ,SAAS,OAAO,IAAc;AACnC,cAAY;AACZ,YAAU;AAEV,cAAY;AACd;;;ACQO,SAAS,KAAQ,KAAiB,KAAe;AAEtD,QAAM,UAAU;AAAA,IACd;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,EACX;AAOA,MAAI,IAAI,UAAU;AAEhB,QAAI,SAAS,UAAU;AACvB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB,OAAO;AAEL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AACF;AAMO,SAAS,UAAU,MAAwB;AAEhD,MAAIA,QAAO;AACX,MAAI,eAA2B,CAAC;AAEhC,SAAOA,OAAM;AACX,iBAAa,KAAKA,MAAK,GAAG;AAC1B,IAAAA,QAAOA,MAAK;AAAA,EACd;AAGA,eAAa,QAAQ,CAACC,YAAWA,QAAO,CAAC;AAC3C;;;ACrDO,IAAM,UAAN,MAAiB;AAAA;AAAA;AAAA;AAAA,EAId;AAAA;AAAA;AAAA;AAAA,EAKR,CAAW,wBAAoB,IAAa;AAAA;AAAA;AAAA;AAAA,EAK5C;AAAA;AAAA;AAAA;AAAA,EAKA;AAAA,EAEA,YAAY,OAAU;AACpB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAW;AAEb,QAAI,WAAW;AACb,eAAS,IAAI;AAAA,IACf;AAEA,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAM,UAAa;AAGrB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAOO,SAAS,IAAO,OAAU;AAC/B,SAAO,IAAI,QAAW,KAAK;AAC7B;AAOO,SAAS,MAAM,OAAO;AAC3B,SAAO,CAAC,EAAE,SAAS,MAAM,wBAAoB;AAC/C;AAMO,SAAS,SAAY,KAAiB;AAC3C,MAAI,WAAW;AACb,SAAK,KAAK,SAAS;AAAA,EACrB;AACF;AAMO,SAAS,WAAc,KAAiB;AAC7C,MAAI,IAAI,MAAM;AAEZ,cAAU,IAAI,IAAI;AAAA,EACpB;AACF;",
  "names": ["link", "effect"]
}
